<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ÂãùtoooN</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(135deg, #eaf4f0, #dce8f5);
      color: #3a3a3a;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      box-sizing: border-box;
    }

    h1 {
      margin: 0;
      padding: 20px 0 6px;
      font-size: 2.2em;
      color: #2e7d5e;
      text-align: center;
      letter-spacing: 0.04em;
      cursor: pointer;
      user-select: none;
    }

    .subtitle {
      font-size: 0.9em;
      color: #6b8a7e;
      margin-bottom: 20px;
      text-align: center;
    }

    .card {
      background: #f8fbfa;
      border-radius: 14px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
      padding: 20px;
      width: 90%;
      max-width: 500px;
      margin-bottom: 20px;
    }

    .average-display {
      text-align: center;
      padding: 10px 0;
    }

    .average-label {
      font-size: 1em;
      color: #6b8a7e;
    }

    .average-value {
      font-size: 3em;
      font-weight: bold;
      color: #2e7d5e;
      line-height: 1.2;
      transition: color 0.3s;
    }

    .average-value.over-border {
      color: #d63031;
    }

    .average-unit {
      font-size: 0.9em;
      color: #6b8a7e;
    }

    .count-label {
      font-size: 0.85em;
      color: #8fa89e;
      margin-top: 4px;
    }

    .input-area {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 10px;
    }

    input[type="number"] {
      flex: 1;
      padding: 12px;
      font-size: 1.2em;
      border: 2px solid #c4ddd4;
      border-radius: 8px;
      outline: none;
      background: #fff;
      color: #3a3a3a;
      transition: border-color 0.2s;
      -moz-appearance: textfield;
    }

    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    input[type="number"]:focus {
      border-color: #2e7d5e;
    }

    button {
      padding: 12px 20px;
      font-size: 1em;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.2s, transform 0.1s;
    }

    button:active {
      transform: scale(0.97);
    }

    .btn-add {
      background-color: #2e7d5e;
      color: #fff;
      width: 100%;
      padding: 16px 20px;
      font-size: 1.2em;
    }

    .btn-add:hover {
      background-color: #245f48;
    }

    .btn-row {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .btn-reset {
      flex: 1;
      background-color: #c0392b;
      color: #fff;
    }

    .btn-reset:hover {
      background-color: #a93226;
    }

    .btn-undo {
      flex: 1;
      background-color: #8fa89e;
      color: #fff;
    }

    .btn-undo:hover {
      background-color: #728f84;
    }

    .btn-undo:disabled {
      background-color: #d9e5e1;
      color: #aabdb6;
      cursor: not-allowed;
    }

    .btn-segment {
      flex: 1;
      background-color: #e67e22;
      color: #fff;
    }

    .btn-segment:hover {
      background-color: #ca6f1e;
    }

    .btn-segment:disabled {
      background-color: #f0d8b5;
      color: #c9a068;
      cursor: not-allowed;
    }

    .btn-delete-entry {
      background: none;
      border: 1px solid #d9e5e1;
      color: #c0392b;
      font-size: 0.85em;
      padding: 2px 7px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      line-height: 1.3;
      min-width: 28px;
      transition: background-color 0.2s;
    }

    .btn-delete-entry:hover {
      background-color: #fdecea;
    }

    .segment-separator {
      color: #8fa89e;
      font-size: 0.85em;
      text-align: center;
      width: 100%;
      padding: 4px 0;
    }

    .history-list li.segment-separator-row {
      padding: 5px 12px;
      border-top: 2px solid #c4ddd4;
      border-bottom: 2px solid #c4ddd4;
      background-color: #eef5f2;
    }

    .history-list li.past-segment-entry {
      background-color: #f4f9f7;
      opacity: 0.85;
    }

    .history-title {
      font-size: 1em;
      font-weight: bold;
      color: #4a6e62;
      margin-bottom: 10px;
    }

    .history-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 300px;
      overflow-y: auto;
    }

    .history-list li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border-bottom: 1px solid #e2efeb;
      font-size: 1em;
    }

    .history-list li:last-child {
      border-bottom: none;
    }

    .history-list .entry-num {
      color: #8fa89e;
      font-size: 0.85em;
      min-width: 30px;
    }

    .history-list .entry-val {
      font-weight: bold;
      font-size: 1.1em;
      color: #3a3a3a;
    }

    .history-list .entry-unit {
      color: #6b8a7e;
      font-size: 0.85em;
    }

    .history-list .entry-start {
      color: #4a6e62;
      font-size: 0.9em;
      flex: 1;
      text-align: center;
    }

    .history-list .entry-rotation {
      font-weight: bold;
      font-size: 1.1em;
      color: #2e7d5e;
    }

    .history-list .entry-base {
      color: #8fa89e;
      font-size: 0.9em;
    }

    .empty-message {
      color: #aabdb6;
      text-align: center;
      padding: 20px 0;
      font-size: 0.95em;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    @media (max-width: 400px) {
      h1 {
        font-size: 1.7em;
      }

      .average-value {
        font-size: 2.5em;
      }

      button {
        padding: 10px 14px;
        font-size: 0.95em;
      }
    }

    /* ===== BLING MODE ===== */
    @keyframes rainbow-text {
      0%   { color: #ff0000; text-shadow: 0 0 18px #ff0000, 0 0 36px #ff000066; }
      14%  { color: #ff8800; text-shadow: 0 0 18px #ff8800, 0 0 36px #ff880066; }
      28%  { color: #ffe000; text-shadow: 0 0 18px #ffe000, 0 0 36px #ffe00066; }
      43%  { color: #00cc44; text-shadow: 0 0 18px #00cc44, 0 0 36px #00cc4466; }
      57%  { color: #0099ff; text-shadow: 0 0 18px #0099ff, 0 0 36px #0099ff66; }
      71%  { color: #9900ff; text-shadow: 0 0 18px #9900ff, 0 0 36px #9900ff66; }
      85%  { color: #ff00cc; text-shadow: 0 0 18px #ff00cc, 0 0 36px #ff00cc66; }
      100% { color: #ffd700; text-shadow: 0 0 18px #ffd700, 0 0 36px #ffd70066; }
    }

    @keyframes bg-shimmer {
      0%   { background-position: 0% 50%; }
      50%  { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    h1.bling-mode {
      animation: rainbow-text 1.5s linear infinite;
    }

    body.bling-mode {
      background-image: linear-gradient(
        135deg,
        #ff000044, #ff880044, #ffe00044, #00cc4444,
        #0099ff44, #9900ff44, #ff00cc44, #ffd70044,
        #ff000044
      );
      background-size: 400% 400%;
      animation: bg-shimmer 4s ease infinite;
    }

    body.bling-mode .card {
      background: rgba(18, 8, 36, 0.92);
      border: 2px solid #ffd700;
      box-shadow: 0 0 24px rgba(255, 215, 0, 0.45), 0 3px 10px rgba(0, 0, 0, 0.35);
      color: #fff;
    }

    body.bling-mode .subtitle,
    body.bling-mode .average-label,
    body.bling-mode .average-unit,
    body.bling-mode .count-label,
    body.bling-mode .history-title {
      color: #ffd700;
    }

    body.bling-mode .average-value {
      animation: rainbow-text 1.5s linear infinite;
    }

    body.bling-mode .history-list .entry-val,
    body.bling-mode .history-list .entry-start {
      color: #ffffff;
    }

    body.bling-mode .history-list .entry-num,
    body.bling-mode .history-list .entry-base {
      color: #aaaaff;
    }

    body.bling-mode .history-list .entry-rotation {
      color: #ffd700;
    }

    body.bling-mode .history-list li {
      border-bottom-color: rgba(255, 215, 0, 0.2);
    }

    body.bling-mode input[type="number"] {
      background: rgba(255, 255, 255, 0.1);
      border-color: #ffd700;
      color: #fff;
    }

    body.bling-mode input[type="number"]::placeholder {
      color: #aaaaaa;
    }

    body.bling-mode .btn-delete-entry {
      border-color: rgba(255, 215, 0, 0.3);
      color: #ff6666;
    }

    body.bling-mode .btn-delete-entry:hover {
      background-color: rgba(255, 0, 0, 0.2);
    }

    body.bling-mode .history-list li.segment-separator-row {
      border-top-color: rgba(255, 215, 0, 0.5);
      border-bottom-color: rgba(255, 215, 0, 0.5);
      background-color: rgba(255, 215, 0, 0.06);
    }

    body.bling-mode .history-list li.past-segment-entry {
      opacity: 0.7;
    }

    /* Screenshot button */
    .btn-screenshot {
      flex: 1;
      background-color: #7c4dff;
      color: #fff;
    }

    .btn-screenshot:hover {
      background-color: #6200ea;
    }

    /* Screenshot modal */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-box {
      background: #f8fbfa;
      border-radius: 14px;
      padding: 24px 28px;
      width: 90%;
      max-width: 360px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.18);
    }

    .modal-title {
      font-size: 1.1em;
      font-weight: bold;
      color: #2e7d5e;
      margin-bottom: 16px;
    }

    .modal-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 12px;
    }

    .modal-field label {
      font-size: 0.85em;
      color: #6b8a7e;
    }

    .modal-field input[type="text"] {
      padding: 10px;
      font-size: 1em;
      border: 2px solid #c4ddd4;
      border-radius: 8px;
      outline: none;
      background: #fff;
      color: #3a3a3a;
      transition: border-color 0.2s;
    }

    .modal-field input[type="text"]:focus {
      border-color: #2e7d5e;
    }

    .modal-field input[type="text"][readonly] {
      background: #eef5f2;
      color: #6b8a7e;
      cursor: default;
    }

    .modal-btn-row {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }

    .btn-modal-cancel {
      flex: 1;
      background-color: #8fa89e;
      color: #fff;
    }

    .btn-modal-cancel:hover {
      background-color: #728f84;
    }

    .btn-modal-ok {
      flex: 1;
      background-color: #7c4dff;
      color: #fff;
    }

    .btn-modal-ok:hover {
      background-color: #6200ea;
    }
  </style>
</head>
<body>
  <h1>üèÜ ÂãùtoooN</h1>
  <p class="subtitle">„Çπ„Çø„Éº„ÉàÊï∞„ÇíÂÖ•Âäõ„Åó„Å¶1000ÂÜÜ„ÅÇ„Åü„Çä„ÅÆÂπ≥ÂùáÂõûËª¢Êï∞„ÇíË®àÁÆó„Åó„Åæ„Åô</p>

  <div class="card">
    <div class="average-display">
      <div class="average-label">Âπ≥ÂùáÂõûËª¢Êï∞Ôºà„Éú„Éº„ÉÄ„ÉºÔºâ</div>
      <div class="average-value" id="averageValue">‚Äî</div>
      <div class="average-unit">Âõû / ÂçÉÂÜÜ</div>
      <div class="count-label" id="countLabel">„Éá„Éº„Çø„Å™„Åó</div>
    </div>
    <div class="input-area">
      <label for="startInput" class="sr-only">„Çπ„Çø„Éº„ÉàÊï∞</label>
      <input type="number" id="startInput" placeholder="„Çπ„Çø„Éº„ÉàÊï∞„ÇíÂÖ•Âäõ" min="0" inputmode="numeric">
      <button class="btn-add" id="addBtn">ËøΩÂä†</button>
    </div>
    <div class="btn-row">
      <button class="btn-segment" id="segmentBtn" disabled>üîÑ ‰ªïÂàá„ÇäÁõ¥„Åó</button>
    </div>
    <div class="btn-row">
      <button class="btn-reset" id="resetBtn">„É™„Çª„ÉÉ„Éà</button>
      <button class="btn-undo" id="undoBtn" disabled>„É™„Çª„ÉÉ„ÉàÂèñÊ∂à</button>
    </div>
    <div class="btn-row">
      <button class="btn-screenshot" id="screenshotBtn">üì∏ „Çπ„ÇØ„Ç∑„Éß</button>
    </div>
  </div>

  <div class="card">
    <div class="history-title">üìã ÂÖ•ÂäõÂ±•Ê≠¥</div>
    <ul class="history-list" id="historyList">
      <li><span class="empty-message">„Åæ„Å†„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</span></li>
    </ul>
  </div>

  <div id="screenshotModal" class="modal-overlay" style="display:none;">
    <div class="modal-box">
      <div class="modal-title">üì∏ „Çπ„ÇØ„Ç∑„ÉßË®≠ÂÆö</div>
      <div class="modal-field">
        <label for="modalDate">Êó•‰ªò</label>
        <input type="text" id="modalDate" readonly>
      </div>
      <div class="modal-field">
        <label for="modalStoreName">Â∫óËàóÂêçÔºà‰ªªÊÑèÔºâ</label>
        <input type="text" id="modalStoreName" placeholder="‰æãÔºö„Äá„Äá„Éõ„Éº„É´">
      </div>
      <div class="modal-field">
        <label for="modalMachineType">Ê©üÁ®ÆÔºà‰ªªÊÑèÔºâ</label>
        <input type="text" id="modalMachineType" placeholder="‰æãÔºöÊµ∑Áâ©Ë™û">
      </div>
      <div class="modal-btn-row">
        <button class="btn-modal-cancel" id="modalCancelBtn">„Ç≠„É£„É≥„Çª„É´</button>
        <button class="btn-modal-ok" id="modalOkBtn">„Çπ„ÇØ„Ç∑„Éß‰øùÂ≠ò</button>
      </div>
    </div>
  </div>

  <script>
    let starts = [];
    let savedStarts = null;
    let pastSegments = [];
    let savedPastSegments = null;

    const startInput = document.getElementById('startInput');
    const averageValue = document.getElementById('averageValue');
    const countLabel = document.getElementById('countLabel');
    const historyList = document.getElementById('historyList');
    const undoBtn = document.getElementById('undoBtn');
    const segmentBtn = document.getElementById('segmentBtn');
    const h1El = document.querySelector('h1');

    // ===== Bling mode toggle on title click =====
    h1El.addEventListener('click', function () {
      h1El.classList.toggle('bling-mode');
      document.body.classList.toggle('bling-mode');
    });

    startInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') addEntry();
    });

    document.getElementById('addBtn').addEventListener('click', addEntry);
    document.getElementById('resetBtn').addEventListener('click', resetEntries);
    document.getElementById('segmentBtn').addEventListener('click', resetSegment);
    undoBtn.addEventListener('click', undoReset);
    document.getElementById('screenshotBtn').addEventListener('click', takeScreenshot);

    function addEntry() {
      const val = parseInt(startInput.value, 10);
      if (isNaN(val) || val < 0) {
        startInput.focus();
        return;
      }
      if (starts.length > 0 && val < starts[starts.length - 1]) {
        alert('„Çπ„Çø„Éº„ÉàÊï∞„ÅØÂâçÂõû„ÅÆÂÄ§‰ª•‰∏ä„ÅÆÊï∞„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        startInput.focus();
        return;
      }
      starts.push(val);
      savedStarts = null;
      savedPastSegments = null;
      undoBtn.disabled = true;
      startInput.value = '';
      startInput.focus();
      render();
    }

    function resetSegment() {
      if (starts.length < 2) return;
      pastSegments.push(starts.slice());
      starts = [];
      savedStarts = null;
      savedPastSegments = null;
      undoBtn.disabled = true;
      render();
    }

    function deleteEntry(idx) {
      starts.splice(idx, 1);
      savedStarts = null;
      savedPastSegments = null;
      undoBtn.disabled = true;
      render();
    }

    function resetEntries() {
      if (starts.length === 0 && pastSegments.length === 0) return;
      savedStarts = starts.slice();
      savedPastSegments = pastSegments.slice();
      starts = [];
      pastSegments = [];
      undoBtn.disabled = false;
      render();
    }

    function undoReset() {
      if (savedStarts === null) return;
      starts = savedStarts.slice();
      pastSegments = savedPastSegments ? savedPastSegments.slice() : [];
      savedStarts = null;
      savedPastSegments = null;
      undoBtn.disabled = true;
      render();
    }

    function render() {
      const currentRotations = [];
      for (let i = 1; i < starts.length; i++) {
        currentRotations.push(starts[i] - starts[i - 1]);
      }
      const pastRotations = [];
      pastSegments.forEach(function(seg) {
        for (let i = 1; i < seg.length; i++) {
          pastRotations.push(seg[i] - seg[i - 1]);
        }
      });
      const allRotations = pastRotations.concat(currentRotations);

      if (starts.length === 0 && pastSegments.length === 0) {
        averageValue.textContent = '‚Äî';
        averageValue.classList.remove('over-border');
        countLabel.textContent = '„Éá„Éº„Çø„Å™„Åó';
        historyList.innerHTML = '<li><span class="empty-message">„Åæ„Å†„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</span></li>';
        segmentBtn.disabled = true;
        return;
      }

      if (allRotations.length === 0) {
        averageValue.textContent = '‚Äî';
        averageValue.classList.remove('over-border');
        countLabel.textContent = starts.length > 0 ? 'Âü∫Ê∫ñ„Çπ„Çø„Éº„ÉàÊï∞: ' + starts[0] : '„Éá„Éº„Çø„Å™„Åó';
      } else {
        const sum = allRotations.reduce((a, b) => a + b, 0);
        const avg = (sum / allRotations.length).toFixed(1);
        averageValue.textContent = avg;
        averageValue.classList.toggle('over-border', parseFloat(avg) >= 20);
        countLabel.textContent = allRotations.length + ' ÂõûÂàÜ„ÅÆ„Éá„Éº„ÇøÔºàÂêàË®à ' + sum + ' ÂõûÔºâ';
      }

      segmentBtn.disabled = starts.length < 2;

      historyList.innerHTML = '';
      if (starts.length > 0) {
        starts.slice().reverse().forEach(function(start, reversedIdx) {
          const origIdx = starts.length - 1 - reversedIdx;
          const displayIdx = origIdx + 1;
          const li = document.createElement('li');
          const delBtn = document.createElement('button');
          delBtn.className = 'btn-delete-entry';
          delBtn.textContent = '√ó';
          delBtn.setAttribute('aria-label', 'ÂâäÈô§');
          delBtn.addEventListener('click', function() { deleteEntry(origIdx); });
          if (origIdx === 0) {
            li.innerHTML =
              '<span class="entry-num">' + displayIdx + '</span>' +
              '<span class="entry-start">„Çπ„Çø„Éº„Éà: ' + start + '</span>' +
              '<span class="entry-base">Âü∫Ê∫ñ</span>';
          } else {
            const rotation = starts[origIdx] - starts[origIdx - 1];
            li.innerHTML =
              '<span class="entry-num">' + displayIdx + '</span>' +
              '<span class="entry-start">„Çπ„Çø„Éº„Éà: ' + start + '</span>' +
              '<span class="entry-rotation">' + rotation + '</span>' +
              '<span class="entry-unit">Âõû / ÂçÉÂÜÜ</span>';
          }
          li.appendChild(delBtn);
          historyList.appendChild(li);
        });
      }

      if (pastSegments.length > 0) {
        pastSegments.slice().reverse().forEach(function(seg) {
          const segLi = document.createElement('li');
          segLi.className = 'segment-separator-row';
          const segRotations = [];
          for (let i = 1; i < seg.length; i++) {
            segRotations.push(seg[i] - seg[i - 1]);
          }
          const segSum = segRotations.reduce((a, b) => a + b, 0);
          segLi.innerHTML = '<span class="segment-separator">‚Äî ‰ªïÂàá„ÇäÁõ¥„Åó: ' + segRotations.length + ' ÂõûÂàÜÔºàÂêàË®à ' + segSum + ' ÂõûÔºâ‚Äî</span>';
          historyList.appendChild(segLi);
          seg.slice().reverse().forEach(function(start, reversedIdx) {
            const origIdx = seg.length - 1 - reversedIdx;
            const displayIdx = origIdx + 1;
            const li = document.createElement('li');
            li.className = 'past-segment-entry';
            if (origIdx === 0) {
              li.innerHTML =
                '<span class="entry-num">' + displayIdx + '</span>' +
                '<span class="entry-start">„Çπ„Çø„Éº„Éà: ' + start + '</span>' +
                '<span class="entry-base">Âü∫Ê∫ñ</span>';
            } else {
              const rotation = seg[origIdx] - seg[origIdx - 1];
              li.innerHTML =
                '<span class="entry-num">' + displayIdx + '</span>' +
                '<span class="entry-start">„Çπ„Çø„Éº„Éà: ' + start + '</span>' +
                '<span class="entry-rotation">' + rotation + '</span>' +
                '<span class="entry-unit">Âõû / ÂçÉÂÜÜ</span>';
            }
            historyList.appendChild(li);
          });
        });
      }
    }

    // ===== Screenshot =====
    function takeScreenshot() {
      if (starts.length === 0 && pastSegments.length === 0) {
        alert('„Åæ„Å†„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
        return;
      }
      var now = new Date();
      var dateStr = now.getFullYear() + 'Âπ¥' + (now.getMonth() + 1) + 'Êúà' + now.getDate() + 'Êó•';
      document.getElementById('modalDate').value = dateStr;
      document.getElementById('modalStoreName').value = '';
      document.getElementById('modalMachineType').value = '';
      document.getElementById('screenshotModal').style.display = 'flex';
    }

    document.getElementById('modalCancelBtn').addEventListener('click', function() {
      document.getElementById('screenshotModal').style.display = 'none';
    });

    document.getElementById('modalOkBtn').addEventListener('click', function() {
      var dateStr = document.getElementById('modalDate').value;
      var storeName = document.getElementById('modalStoreName').value.trim();
      var machineType = document.getElementById('modalMachineType').value.trim();
      document.getElementById('screenshotModal').style.display = 'none';
      generateAndDownloadScreenshot(dateStr, storeName, machineType);
    });
    function drawStar(ctx, x, y, r, color) {
      ctx.beginPath();
      for (var pointIndex = 0; pointIndex < 8; pointIndex++) {
        var angle = (pointIndex / 8) * Math.PI * 2 - Math.PI / 2;
        var radius = pointIndex % 2 === 0 ? r : r * 0.42;
        if (pointIndex === 0) {
          ctx.moveTo(x + Math.cos(angle) * radius, y + Math.sin(angle) * radius);
        } else {
          ctx.lineTo(x + Math.cos(angle) * radius, y + Math.sin(angle) * radius);
        }
      }
      ctx.closePath();
      ctx.fillStyle = color;
      ctx.fill();
    }

    function generateAndDownloadScreenshot(dateStr, storeName, machineType) {
      var currentRotations = [];
      for (var i = 1; i < starts.length; i++) {
        currentRotations.push(starts[i] - starts[i - 1]);
      }
      var allPastRotations = [];
      pastSegments.forEach(function(seg) {
        for (var si = 1; si < seg.length; si++) {
          allPastRotations.push(seg[si] - seg[si - 1]);
        }
      });
      var rotations = allPastRotations.concat(currentRotations);
      var sum = rotations.length > 0 ? rotations.reduce(function(a, b) { return a + b; }, 0) : 0;
      var avg = rotations.length > 0 ? parseFloat((sum / rotations.length).toFixed(1)) : null;
      var isFancy = avg !== null && avg >= 20;

      var W = 520;
      var pad = 32;
      var rowH = 38;
      var pastRows = 0;
      pastSegments.forEach(function(seg) { pastRows += 1 + seg.length; });
      var H = 238 + (starts.length + pastRows) * rowH + 60;

      var canvas = document.createElement('canvas');
      canvas.width = W;
      canvas.height = H;
      var ctx = canvas.getContext('2d');

      // Background
      if (isFancy) {
        var bg = ctx.createLinearGradient(0, 0, W, H);
        bg.addColorStop(0,    '#1a0030');
        bg.addColorStop(0.25, '#002a10');
        bg.addColorStop(0.5,  '#001a3a');
        bg.addColorStop(0.75, '#2a0010');
        bg.addColorStop(1,    '#1a1a00');
        ctx.fillStyle = bg;
      } else {
        ctx.fillStyle = '#f8fbfa';
      }
      ctx.fillRect(0, 0, W, H);

      if (isFancy) {
        // Rainbow border (outer + inner)
        var borderGrad = ctx.createLinearGradient(0, 0, W, H);
        var bColors = ['#ff0000','#ff8800','#ffe000','#00cc44','#0099ff','#9900ff','#ff00cc','#ffd700'];
        bColors.forEach(function(c, idx) { borderGrad.addColorStop(idx / (bColors.length - 1), c); });
        ctx.strokeStyle = borderGrad;
        ctx.lineWidth = 7;
        ctx.strokeRect(3.5, 3.5, W - 7, H - 7);
        ctx.lineWidth = 3;
        ctx.strokeRect(13, 13, W - 26, H - 26);

        // Scatter sparkle stars (28 stars for a lively festive look)
        var sparkColors = ['#ffd700','#ff4444','#44ff88','#44ddff','#ff44ff','#ffffff'];
        for (var s = 0; s < 28; s++) {
          var sx = Math.random() * W;
          var sy = Math.random() * H;
          var sr = Math.random() * 7 + 3;
          drawStar(ctx, sx, sy, sr, sparkColors[s % sparkColors.length]);
        }
      }

      // Title
      ctx.textAlign = 'center';
      ctx.font = 'bold 30px sans-serif';
      if (isFancy) {
        ctx.fillStyle = '#ffd700';
        ctx.shadowColor = '#ffd700';
        ctx.shadowBlur = 16;
      } else {
        ctx.fillStyle = '#2e7d5e';
        ctx.shadowBlur = 0;
      }
      ctx.fillText('üèÜ Âãùtooon', W / 2, 54);
      ctx.shadowBlur = 0;

      // Metadata line: date + optional store/machine
      ctx.font = '13px sans-serif';
      ctx.fillStyle = isFancy ? '#aaaaff' : '#6b8a7e';
      var metaParts = [dateStr];
      if (storeName) metaParts.push('Â∫óËàó: ' + storeName);
      if (machineType) metaParts.push('Ê©üÁ®Æ: ' + machineType);
      ctx.fillText(metaParts.join('  '), W / 2, 74);

      // Average label
      ctx.font = '16px sans-serif';
      ctx.fillStyle = isFancy ? '#aaaaff' : '#6b8a7e';
      ctx.fillText('Âπ≥ÂùáÂõûËª¢Êï∞Ôºà„Éú„Éº„ÉÄ„ÉºÔºâ', W / 2, 100);

      // Average value
      ctx.font = 'bold 64px sans-serif';
      if (isFancy) {
        var avgGrad = ctx.createLinearGradient(W / 2 - 90, 0, W / 2 + 90, 0);
        ['#ff0000','#ffdd00','#00ff88','#00ccff','#ff00cc','#ffd700'].forEach(function(c, idx, arr) {
          avgGrad.addColorStop(idx / (arr.length - 1), c);
        });
        ctx.fillStyle = avgGrad;
        ctx.shadowColor = '#ffd700';
        ctx.shadowBlur = 22;
      } else if (avg !== null && avg >= 20) {
        ctx.fillStyle = '#d63031';
      } else {
        ctx.fillStyle = '#2e7d5e';
      }
      ctx.fillText(avg !== null ? String(avg) : '‚Äî', W / 2, 176);
      ctx.shadowBlur = 0;

      // Unit
      ctx.font = '17px sans-serif';
      ctx.fillStyle = isFancy ? '#ffd700' : '#6b8a7e';
      ctx.fillText('Âõû / ÂçÉÂÜÜ', W / 2, 202);

      // Count label
      ctx.font = '14px sans-serif';
      ctx.fillStyle = isFancy ? '#8888ff' : '#8fa89e';
      if (rotations.length > 0) {
        ctx.fillText(rotations.length + ' ÂõûÂàÜ„ÅÆ„Éá„Éº„ÇøÔºàÂêàË®à ' + sum + ' ÂõûÔºâ', W / 2, 223);
      } else if (starts.length > 0) {
        ctx.fillText('Âü∫Ê∫ñ„Çπ„Çø„Éº„ÉàÊï∞: ' + starts[0], W / 2, 223);
      } else {
        ctx.fillText('Ââç„Çª„Ç∞„É°„É≥„Éà„ÅÆ„Åø', W / 2, 223);
      }

      // Divider
      ctx.strokeStyle = isFancy ? 'rgba(255,215,0,0.4)' : '#e2efeb';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(pad, 235);
      ctx.lineTo(W - pad, 235);
      ctx.stroke();

      // History header
      ctx.textAlign = 'left';
      ctx.font = 'bold 15px sans-serif';
      ctx.fillStyle = isFancy ? '#ffd700' : '#4a6e62';
      ctx.fillText('üìã ÂÖ•ÂäõÂ±•Ê≠¥', pad, 255);

      var rainbowRow = ['#ff6688','#ffaa00','#aaff44','#44ffee','#8866ff','#ff66cc'];

      starts.slice().reverse().forEach(function(start, rIdx) {
        var origIdx = starts.length - 1 - rIdx;
        var dispIdx = origIdx + 1;
        var y = 255 + (rIdx + 1) * rowH;

        // Row index
        ctx.textAlign = 'left';
        ctx.font = '13px sans-serif';
        ctx.fillStyle = isFancy ? rainbowRow[rIdx % rainbowRow.length] : '#8fa89e';
        ctx.fillText(dispIdx + '.', pad, y);

        // Start value
        ctx.fillStyle = isFancy ? '#ffffff' : '#3a3a3a';
        ctx.fillText('„Çπ„Çø„Éº„Éà: ' + start, pad + 36, y);

        // Rotation or base
        ctx.textAlign = 'right';
        if (origIdx === 0) {
          ctx.font = '13px sans-serif';
          ctx.fillStyle = isFancy ? '#888899' : '#8fa89e';
          ctx.fillText('Âü∫Ê∫ñ', W - pad, y);
        } else {
          var rot = starts[origIdx] - starts[origIdx - 1];
          ctx.font = 'bold 14px sans-serif';
          if (isFancy) {
            ctx.fillStyle = '#ffd700';
            ctx.shadowColor = '#ffd700';
            ctx.shadowBlur = 8;
          } else {
            ctx.fillStyle = '#2e7d5e';
          }
          ctx.fillText(rot + ' Âõû/ÂçÉÂÜÜ', W - pad, y);
          ctx.shadowBlur = 0;
        }
      });

      if (pastSegments.length > 0) {
        var currentY = 255 + starts.length * rowH;
        pastSegments.slice().reverse().forEach(function(seg) {
          currentY += rowH;
          var segY = currentY;
          var segRotations = [];
          for (var si = 1; si < seg.length; si++) {
            segRotations.push(seg[si] - seg[si - 1]);
          }
          var segSum = segRotations.reduce(function(a, b) { return a + b; }, 0);

          ctx.strokeStyle = isFancy ? 'rgba(255,215,0,0.5)' : '#c4ddd4';
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.moveTo(pad, segY - Math.round(rowH * 0.55));
          ctx.lineTo(W - pad, segY - Math.round(rowH * 0.55));
          ctx.stroke();

          ctx.textAlign = 'center';
          ctx.font = '12px sans-serif';
          ctx.fillStyle = isFancy ? '#888899' : '#8fa89e';
          ctx.fillText('‰ªïÂàá„ÇäÁõ¥„Åó: ' + segRotations.length + ' ÂõûÂàÜÔºàÂêàË®à ' + segSum + ' ÂõûÔºâ', W / 2, segY);

          seg.slice().reverse().forEach(function(start, rIdx) {
            var origIdx = seg.length - 1 - rIdx;
            var dispIdx = origIdx + 1;
            currentY += rowH;
            var y = currentY;

            ctx.textAlign = 'left';
            ctx.font = '13px sans-serif';
            ctx.fillStyle = isFancy ? rainbowRow[rIdx % rainbowRow.length] : '#8fa89e';
            ctx.fillText(dispIdx + '.', pad, y);

            ctx.fillStyle = isFancy ? 'rgba(255,255,255,0.65)' : '#6b8a7e';
            ctx.fillText('„Çπ„Çø„Éº„Éà: ' + start, pad + 36, y);

            ctx.textAlign = 'right';
            if (origIdx === 0) {
              ctx.font = '13px sans-serif';
              ctx.fillStyle = isFancy ? '#666677' : '#8fa89e';
              ctx.fillText('Âü∫Ê∫ñ', W - pad, y);
            } else {
              var rot = seg[origIdx] - seg[origIdx - 1];
              ctx.font = 'bold 14px sans-serif';
              ctx.fillStyle = isFancy ? 'rgba(255,215,0,0.65)' : '#6b8a7e';
              ctx.fillText(rot + ' Âõû/ÂçÉÂÜÜ', W - pad, y);
            }
          });
        });
      }

      // Timestamp
      ctx.textAlign = 'center';
      ctx.font = '12px sans-serif';
      ctx.fillStyle = isFancy ? '#666677' : '#aabdb6';
      ctx.fillText(new Date().toLocaleString('ja-JP'), W / 2, H - 18);

      // Download
      var now = new Date();
      var datePart = now.getFullYear() + '-' +
        String(now.getMonth() + 1).padStart(2, '0') + '-' +
        String(now.getDate()).padStart(2, '0') + '-' +
        String(now.getHours()).padStart(2, '0') +
        String(now.getMinutes()).padStart(2, '0') +
        String(now.getSeconds()).padStart(2, '0');
      canvas.toBlob(function(blob) {
        var url = URL.createObjectURL(blob);
        var link = document.createElement('a');
        link.download = 'Âãùtooon-' + datePart + '.png';
        link.href = url;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }, 'image/png');
    }
  </script>
</body>
</html>
