<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Âãùtooon</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(135deg, #eaf4f0, #dce8f5);
      color: #3a3a3a;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      box-sizing: border-box;
    }

    h1 {
      margin: 0;
      padding: 20px 0 6px;
      font-size: 2.2em;
      color: #2e7d5e;
      text-align: center;
      letter-spacing: 0.04em;
      cursor: pointer;
      user-select: none;
    }

    .subtitle {
      font-size: 0.9em;
      color: #6b8a7e;
      margin-bottom: 20px;
      text-align: center;
    }

    .card {
      background: #f8fbfa;
      border-radius: 14px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
      padding: 20px;
      width: 90%;
      max-width: 500px;
      margin-bottom: 20px;
    }

    .average-display {
      text-align: center;
      padding: 10px 0;
    }

    .average-label {
      font-size: 1em;
      color: #6b8a7e;
    }

    .average-value {
      font-size: 3em;
      font-weight: bold;
      color: #2e7d5e;
      line-height: 1.2;
      transition: color 0.3s;
    }

    .average-value.over-border {
      color: #d63031;
    }

    .average-unit {
      font-size: 0.9em;
      color: #6b8a7e;
    }

    .count-label {
      font-size: 0.85em;
      color: #8fa89e;
      margin-top: 4px;
    }

    .input-area {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    input[type="number"] {
      flex: 1;
      padding: 12px;
      font-size: 1.2em;
      border: 2px solid #c4ddd4;
      border-radius: 8px;
      outline: none;
      background: #fff;
      color: #3a3a3a;
      transition: border-color 0.2s;
      -moz-appearance: textfield;
    }

    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    input[type="number"]:focus {
      border-color: #2e7d5e;
    }

    button {
      padding: 12px 20px;
      font-size: 1em;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.2s, transform 0.1s;
    }

    button:active {
      transform: scale(0.97);
    }

    .btn-add {
      background-color: #2e7d5e;
      color: #fff;
    }

    .btn-add:hover {
      background-color: #245f48;
    }

    .btn-row {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .btn-reset {
      flex: 1;
      background-color: #c0392b;
      color: #fff;
    }

    .btn-reset:hover {
      background-color: #a93226;
    }

    .btn-undo {
      flex: 1;
      background-color: #8fa89e;
      color: #fff;
    }

    .btn-undo:hover {
      background-color: #728f84;
    }

    .btn-undo:disabled {
      background-color: #d9e5e1;
      color: #aabdb6;
      cursor: not-allowed;
    }

    .history-title {
      font-size: 1em;
      font-weight: bold;
      color: #4a6e62;
      margin-bottom: 10px;
    }

    .history-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 300px;
      overflow-y: auto;
    }

    .history-list li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border-bottom: 1px solid #e2efeb;
      font-size: 1em;
    }

    .history-list li:last-child {
      border-bottom: none;
    }

    .history-list .entry-num {
      color: #8fa89e;
      font-size: 0.85em;
      min-width: 30px;
    }

    .history-list .entry-val {
      font-weight: bold;
      font-size: 1.1em;
      color: #3a3a3a;
    }

    .history-list .entry-unit {
      color: #6b8a7e;
      font-size: 0.85em;
    }

    .history-list .entry-start {
      color: #4a6e62;
      font-size: 0.9em;
      flex: 1;
      text-align: center;
    }

    .history-list .entry-rotation {
      font-weight: bold;
      font-size: 1.1em;
      color: #2e7d5e;
    }

    .history-list .entry-base {
      color: #8fa89e;
      font-size: 0.9em;
    }

    .empty-message {
      color: #aabdb6;
      text-align: center;
      padding: 20px 0;
      font-size: 0.95em;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    @media (max-width: 400px) {
      h1 {
        font-size: 1.7em;
      }

      .average-value {
        font-size: 2.5em;
      }

      button {
        padding: 10px 14px;
        font-size: 0.95em;
      }
    }

    /* ===== BLING MODE ===== */
    @keyframes rainbow-text {
      0%   { color: #ff0000; text-shadow: 0 0 18px #ff0000, 0 0 36px #ff000066; }
      14%  { color: #ff8800; text-shadow: 0 0 18px #ff8800, 0 0 36px #ff880066; }
      28%  { color: #ffe000; text-shadow: 0 0 18px #ffe000, 0 0 36px #ffe00066; }
      43%  { color: #00cc44; text-shadow: 0 0 18px #00cc44, 0 0 36px #00cc4466; }
      57%  { color: #0099ff; text-shadow: 0 0 18px #0099ff, 0 0 36px #0099ff66; }
      71%  { color: #9900ff; text-shadow: 0 0 18px #9900ff, 0 0 36px #9900ff66; }
      85%  { color: #ff00cc; text-shadow: 0 0 18px #ff00cc, 0 0 36px #ff00cc66; }
      100% { color: #ffd700; text-shadow: 0 0 18px #ffd700, 0 0 36px #ffd70066; }
    }

    @keyframes bg-shimmer {
      0%   { background-position: 0% 50%; }
      50%  { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    h1.bling-mode {
      animation: rainbow-text 1.5s linear infinite;
    }

    body.bling-mode {
      background-image: linear-gradient(
        135deg,
        #ff000044, #ff880044, #ffe00044, #00cc4444,
        #0099ff44, #9900ff44, #ff00cc44, #ffd70044,
        #ff000044
      );
      background-size: 400% 400%;
      animation: bg-shimmer 4s ease infinite;
    }

    body.bling-mode .card {
      background: rgba(18, 8, 36, 0.92);
      border: 2px solid #ffd700;
      box-shadow: 0 0 24px rgba(255, 215, 0, 0.45), 0 3px 10px rgba(0, 0, 0, 0.35);
      color: #fff;
    }

    body.bling-mode .subtitle,
    body.bling-mode .average-label,
    body.bling-mode .average-unit,
    body.bling-mode .count-label,
    body.bling-mode .history-title {
      color: #ffd700;
    }

    body.bling-mode .average-value {
      animation: rainbow-text 1.5s linear infinite;
    }

    body.bling-mode .history-list .entry-val,
    body.bling-mode .history-list .entry-start {
      color: #ffffff;
    }

    body.bling-mode .history-list .entry-num,
    body.bling-mode .history-list .entry-base {
      color: #aaaaff;
    }

    body.bling-mode .history-list .entry-rotation {
      color: #ffd700;
    }

    body.bling-mode .history-list li {
      border-bottom-color: rgba(255, 215, 0, 0.2);
    }

    body.bling-mode input[type="number"] {
      background: rgba(255, 255, 255, 0.1);
      border-color: #ffd700;
      color: #fff;
    }

    body.bling-mode input[type="number"]::placeholder {
      color: #aaaaaa;
    }

    /* Screenshot button */
    .btn-screenshot {
      flex: 1;
      background-color: #7c4dff;
      color: #fff;
    }

    .btn-screenshot:hover {
      background-color: #6200ea;
    }
  </style>
</head>
<body>
  <h1>üèÜ Âãùtooon</h1>
  <p class="subtitle">„Çπ„Çø„Éº„ÉàÊï∞„ÇíÂÖ•Âäõ„Åó„Å¶1000ÂÜÜ„ÅÇ„Åü„Çä„ÅÆÂπ≥ÂùáÂõûËª¢Êï∞„ÇíË®àÁÆó„Åó„Åæ„Åô</p>

  <div class="card">
    <div class="average-display">
      <div class="average-label">Âπ≥ÂùáÂõûËª¢Êï∞Ôºà„Éú„Éº„ÉÄ„ÉºÔºâ</div>
      <div class="average-value" id="averageValue">‚Äî</div>
      <div class="average-unit">Âõû / ÂçÉÂÜÜ</div>
      <div class="count-label" id="countLabel">„Éá„Éº„Çø„Å™„Åó</div>
    </div>
    <div class="input-area">
      <label for="startInput" class="sr-only">„Çπ„Çø„Éº„ÉàÊï∞</label>
      <input type="number" id="startInput" placeholder="„Çπ„Çø„Éº„ÉàÊï∞„ÇíÂÖ•Âäõ" min="0" inputmode="numeric">
      <button class="btn-add" id="addBtn">ËøΩÂä†</button>
    </div>
    <div class="btn-row">
      <button class="btn-reset" id="resetBtn">„É™„Çª„ÉÉ„Éà</button>
      <button class="btn-undo" id="undoBtn" disabled>„É™„Çª„ÉÉ„ÉàÂèñÊ∂à</button>
    </div>
    <div class="btn-row">
      <button class="btn-screenshot" id="screenshotBtn">üì∏ „Çπ„ÇØ„Ç∑„Éß</button>
    </div>
  </div>

  <div class="card">
    <div class="history-title">üìã ÂÖ•ÂäõÂ±•Ê≠¥</div>
    <ul class="history-list" id="historyList">
      <li><span class="empty-message">„Åæ„Å†„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</span></li>
    </ul>
  </div>

  <script>
    let starts = [];
    let savedStarts = null;

    const startInput = document.getElementById('startInput');
    const averageValue = document.getElementById('averageValue');
    const countLabel = document.getElementById('countLabel');
    const historyList = document.getElementById('historyList');
    const undoBtn = document.getElementById('undoBtn');
    const h1El = document.querySelector('h1');

    // ===== Bling mode toggle on title click =====
    h1El.addEventListener('click', function () {
      h1El.classList.toggle('bling-mode');
      document.body.classList.toggle('bling-mode');
    });

    startInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') addEntry();
    });

    document.getElementById('addBtn').addEventListener('click', addEntry);
    document.getElementById('resetBtn').addEventListener('click', resetEntries);
    undoBtn.addEventListener('click', undoReset);
    document.getElementById('screenshotBtn').addEventListener('click', takeScreenshot);

    function addEntry() {
      const val = parseInt(startInput.value, 10);
      if (isNaN(val) || val < 0) {
        startInput.focus();
        return;
      }
      if (starts.length > 0 && val < starts[starts.length - 1]) {
        alert('„Çπ„Çø„Éº„ÉàÊï∞„ÅØÂâçÂõû„ÅÆÂÄ§‰ª•‰∏ä„ÅÆÊï∞„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        startInput.focus();
        return;
      }
      starts.push(val);
      savedStarts = null;
      undoBtn.disabled = true;
      startInput.value = '';
      startInput.focus();
      render();
    }

    function resetEntries() {
      if (starts.length === 0) return;
      savedStarts = starts.slice();
      starts = [];
      undoBtn.disabled = false;
      render();
    }

    function undoReset() {
      if (savedStarts === null) return;
      starts = savedStarts.slice();
      savedStarts = null;
      undoBtn.disabled = true;
      render();
    }

    function render() {
      if (starts.length === 0) {
        averageValue.textContent = '‚Äî';
        averageValue.classList.remove('over-border');
        countLabel.textContent = '„Éá„Éº„Çø„Å™„Åó';
        historyList.innerHTML = '<li><span class="empty-message">„Åæ„Å†„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</span></li>';
        return;
      }

      // Calculate rotations per 1000 yen as differences between consecutive start counts
      const rotations = [];
      for (let i = 1; i < starts.length; i++) {
        rotations.push(starts[i] - starts[i - 1]);
      }

      if (rotations.length === 0) {
        averageValue.textContent = '‚Äî';
        averageValue.classList.remove('over-border');
        countLabel.textContent = 'Âü∫Ê∫ñ„Çπ„Çø„Éº„ÉàÊï∞: ' + starts[0];
      } else {
        const sum = rotations.reduce((a, b) => a + b, 0);
        const avg = (sum / rotations.length).toFixed(1);
        averageValue.textContent = avg;
        averageValue.classList.toggle('over-border', parseFloat(avg) >= 20);
        countLabel.textContent = rotations.length + ' ÂõûÂàÜ„ÅÆ„Éá„Éº„ÇøÔºàÂêàË®à ' + sum + ' ÂõûÔºâ';
      }

      historyList.innerHTML = '';
      starts.slice().reverse().forEach(function(start, reversedIdx) {
        const origIdx = starts.length - 1 - reversedIdx;
        const displayIdx = origIdx + 1;
        const li = document.createElement('li');
        if (origIdx === 0) {
          li.innerHTML =
            '<span class="entry-num">' + displayIdx + '</span>' +
            '<span class="entry-start">„Çπ„Çø„Éº„Éà: ' + start + '</span>' +
            '<span class="entry-base">Âü∫Ê∫ñ</span>';
        } else {
          const rotation = starts[origIdx] - starts[origIdx - 1];
          li.innerHTML =
            '<span class="entry-num">' + displayIdx + '</span>' +
            '<span class="entry-start">„Çπ„Çø„Éº„Éà: ' + start + '</span>' +
            '<span class="entry-rotation">' + rotation + '</span>' +
            '<span class="entry-unit">Âõû / ÂçÉÂÜÜ</span>';
        }
        historyList.appendChild(li);
      });
    }

    // ===== Screenshot =====
    function drawStar(ctx, x, y, r, color) {
      ctx.beginPath();
      for (var pointIndex = 0; pointIndex < 8; pointIndex++) {
        var angle = (pointIndex / 8) * Math.PI * 2 - Math.PI / 2;
        var radius = pointIndex % 2 === 0 ? r : r * 0.42;
        if (pointIndex === 0) {
          ctx.moveTo(x + Math.cos(angle) * radius, y + Math.sin(angle) * radius);
        } else {
          ctx.lineTo(x + Math.cos(angle) * radius, y + Math.sin(angle) * radius);
        }
      }
      ctx.closePath();
      ctx.fillStyle = color;
      ctx.fill();
    }

    function takeScreenshot() {
      if (starts.length === 0) {
        alert('„Åæ„Å†„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
        return;
      }

      var rotations = [];
      for (var i = 1; i < starts.length; i++) {
        rotations.push(starts[i] - starts[i - 1]);
      }
      var sum = rotations.length > 0 ? rotations.reduce(function(a, b) { return a + b; }, 0) : 0;
      var avg = rotations.length > 0 ? parseFloat((sum / rotations.length).toFixed(1)) : null;
      var isFancy = avg !== null && avg >= 20;

      var W = 520;
      var pad = 32;
      var rowH = 38;
      var H = 220 + starts.length * rowH + 60;

      var canvas = document.createElement('canvas');
      canvas.width = W;
      canvas.height = H;
      var ctx = canvas.getContext('2d');

      // Background
      if (isFancy) {
        var bg = ctx.createLinearGradient(0, 0, W, H);
        bg.addColorStop(0,    '#1a0030');
        bg.addColorStop(0.25, '#002a10');
        bg.addColorStop(0.5,  '#001a3a');
        bg.addColorStop(0.75, '#2a0010');
        bg.addColorStop(1,    '#1a1a00');
        ctx.fillStyle = bg;
      } else {
        ctx.fillStyle = '#f8fbfa';
      }
      ctx.fillRect(0, 0, W, H);

      if (isFancy) {
        // Rainbow border (outer + inner)
        var borderGrad = ctx.createLinearGradient(0, 0, W, H);
        var bColors = ['#ff0000','#ff8800','#ffe000','#00cc44','#0099ff','#9900ff','#ff00cc','#ffd700'];
        bColors.forEach(function(c, idx) { borderGrad.addColorStop(idx / (bColors.length - 1), c); });
        ctx.strokeStyle = borderGrad;
        ctx.lineWidth = 7;
        ctx.strokeRect(3.5, 3.5, W - 7, H - 7);
        ctx.lineWidth = 3;
        ctx.strokeRect(13, 13, W - 26, H - 26);

        // Scatter sparkle stars (28 stars for a lively festive look)
        var sparkColors = ['#ffd700','#ff4444','#44ff88','#44ddff','#ff44ff','#ffffff'];
        for (var s = 0; s < 28; s++) {
          var sx = Math.random() * W;
          var sy = Math.random() * H;
          var sr = Math.random() * 7 + 3;
          drawStar(ctx, sx, sy, sr, sparkColors[s % sparkColors.length]);
        }
      }

      // Title
      ctx.textAlign = 'center';
      ctx.font = 'bold 30px sans-serif';
      if (isFancy) {
        ctx.fillStyle = '#ffd700';
        ctx.shadowColor = '#ffd700';
        ctx.shadowBlur = 16;
      } else {
        ctx.fillStyle = '#2e7d5e';
        ctx.shadowBlur = 0;
      }
      ctx.fillText('üèÜ Âãùtooon', W / 2, 54);
      ctx.shadowBlur = 0;

      // Average label
      ctx.font = '16px sans-serif';
      ctx.fillStyle = isFancy ? '#aaaaff' : '#6b8a7e';
      ctx.fillText('Âπ≥ÂùáÂõûËª¢Êï∞Ôºà„Éú„Éº„ÉÄ„ÉºÔºâ', W / 2, 82);

      // Average value
      ctx.font = 'bold 64px sans-serif';
      if (isFancy) {
        var avgGrad = ctx.createLinearGradient(W / 2 - 90, 0, W / 2 + 90, 0);
        ['#ff0000','#ffdd00','#00ff88','#00ccff','#ff00cc','#ffd700'].forEach(function(c, idx, arr) {
          avgGrad.addColorStop(idx / (arr.length - 1), c);
        });
        ctx.fillStyle = avgGrad;
        ctx.shadowColor = '#ffd700';
        ctx.shadowBlur = 22;
      } else if (avg !== null && avg >= 20) {
        ctx.fillStyle = '#d63031';
      } else {
        ctx.fillStyle = '#2e7d5e';
      }
      ctx.fillText(avg !== null ? String(avg) : '‚Äî', W / 2, 158);
      ctx.shadowBlur = 0;

      // Unit
      ctx.font = '17px sans-serif';
      ctx.fillStyle = isFancy ? '#ffd700' : '#6b8a7e';
      ctx.fillText('Âõû / ÂçÉÂÜÜ', W / 2, 184);

      // Count label
      ctx.font = '14px sans-serif';
      ctx.fillStyle = isFancy ? '#8888ff' : '#8fa89e';
      if (rotations.length > 0) {
        ctx.fillText(rotations.length + ' ÂõûÂàÜ„ÅÆ„Éá„Éº„ÇøÔºàÂêàË®à ' + sum + ' ÂõûÔºâ', W / 2, 205);
      } else {
        ctx.fillText('Âü∫Ê∫ñ„Çπ„Çø„Éº„ÉàÊï∞: ' + starts[0], W / 2, 205);
      }

      // Divider
      ctx.strokeStyle = isFancy ? 'rgba(255,215,0,0.4)' : '#e2efeb';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(pad, 217);
      ctx.lineTo(W - pad, 217);
      ctx.stroke();

      // History header
      ctx.textAlign = 'left';
      ctx.font = 'bold 15px sans-serif';
      ctx.fillStyle = isFancy ? '#ffd700' : '#4a6e62';
      ctx.fillText('üìã ÂÖ•ÂäõÂ±•Ê≠¥', pad, 237);

      var rainbowRow = ['#ff6688','#ffaa00','#aaff44','#44ffee','#8866ff','#ff66cc'];

      starts.slice().reverse().forEach(function(start, rIdx) {
        var origIdx = starts.length - 1 - rIdx;
        var dispIdx = origIdx + 1;
        var y = 237 + (rIdx + 1) * rowH;

        // Row index
        ctx.textAlign = 'left';
        ctx.font = '13px sans-serif';
        ctx.fillStyle = isFancy ? rainbowRow[rIdx % rainbowRow.length] : '#8fa89e';
        ctx.fillText(dispIdx + '.', pad, y);

        // Start value
        ctx.fillStyle = isFancy ? '#ffffff' : '#3a3a3a';
        ctx.fillText('„Çπ„Çø„Éº„Éà: ' + start, pad + 36, y);

        // Rotation or base
        ctx.textAlign = 'right';
        if (origIdx === 0) {
          ctx.font = '13px sans-serif';
          ctx.fillStyle = isFancy ? '#888899' : '#8fa89e';
          ctx.fillText('Âü∫Ê∫ñ', W - pad, y);
        } else {
          var rot = starts[origIdx] - starts[origIdx - 1];
          ctx.font = 'bold 14px sans-serif';
          if (isFancy) {
            ctx.fillStyle = '#ffd700';
            ctx.shadowColor = '#ffd700';
            ctx.shadowBlur = 8;
          } else {
            ctx.fillStyle = '#2e7d5e';
          }
          ctx.fillText(rot + ' Âõû/ÂçÉÂÜÜ', W - pad, y);
          ctx.shadowBlur = 0;
        }
      });

      // Timestamp
      ctx.textAlign = 'center';
      ctx.font = '12px sans-serif';
      ctx.fillStyle = isFancy ? '#666677' : '#aabdb6';
      ctx.fillText(new Date().toLocaleString('ja-JP'), W / 2, H - 18);

      // Download
      var now = new Date();
      var datePart = now.getFullYear() + '-' +
        String(now.getMonth() + 1).padStart(2, '0') + '-' +
        String(now.getDate()).padStart(2, '0') + '-' +
        String(now.getHours()).padStart(2, '0') +
        String(now.getMinutes()).padStart(2, '0') +
        String(now.getSeconds()).padStart(2, '0');
      canvas.toBlob(function(blob) {
        var url = URL.createObjectURL(blob);
        var link = document.createElement('a');
        link.download = 'Âãùtooon-' + datePart + '.png';
        link.href = url;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }, 'image/png');
    }
  </script>
</body>
</html>
